<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebUSB HID Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            margin-top: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #2ed573;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757, #ff3742);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .pins-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .pin-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: white;
            margin: 5px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .pin-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .pin-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pin-title {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .pin-details {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        .log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 15px;
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 167, 38, 0.4);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                margin: 10px;
                border-radius: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ WebUSB HID Controller</h1>
            <div class="status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Disconnected</span>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>üìå Pin Configuration</h2>
                
                <div class="form-group">
                    <label for="pinNumber">Pin Number:</label>
                    <input type="number" id="pinNumber" min="0" max="20" value="0">
                </div>

                <div class="form-group">
                    <label for="pinMode">Pin Mode:</label>
                    <select id="pinMode">
                        <option value="0">Digital Input</option>
                        <option value="1">Digital Output</option>
                        <option value="2">Analog Input</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="hidAction">HID Action:</label>
                    <select id="hidAction">
                        <option value="0">None</option>
                        <option value="1">Keyboard Key</option>
                        <option value="2">Keyboard Modifier</option>
                        <option value="3">Mouse Button</option>
                        <option value="4">Mouse Movement</option>
                        <option value="5">Media Key</option>
                        <option value="6">Consumer Key</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="actionValue">Action Value/Key Code:</label>
                    <select id="actionValue">
                        <option value="32">Space (32)</option>
                        <option value="13">Enter (13)</option>
                        <option value="9">Tab (9)</option>
                        <option value="27">Escape (27)</option>
                        <option value="65">A (65)</option>
                        <option value="1">Mouse Left (1)</option>
                        <option value="2">Mouse Right (2)</option>
                        <option value="4">Mouse Middle (4)</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="pullupEnabled">
                        <label for="pullupEnabled">Enable Pullup</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="invertLogic">
                        <label for="invertLogic">Invert Logic</label>
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <button class="btn" onclick="addPin()">‚ûï Add Pin</button>
                    <button class="btn btn-danger" onclick="clearAllPins()">üóëÔ∏è Clear All</button>
                </div>

                <div class="quick-actions">
                    <button class="action-btn" onclick="setupKeyboard()">‚å®Ô∏è Keyboard Setup</button>
                    <button class="action-btn" onclick="setupMouse()">üñ±Ô∏è Mouse Setup</button>
                    <button class="action-btn" onclick="setupMedia()">üéµ Media Setup</button>
                    <button class="action-btn" onclick="setupGaming()">üéÆ Gaming Setup</button>
                </div>
            </div>

            <div class="panel">
                <h2>üìã Active Pins</h2>
                <div id="pinsList" class="pins-list">
                    <div style="padding: 20px; text-align: center; color: #999;">
                        No pins configured. Add some pins to get started!
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="refreshPins()">üîÑ Refresh</button>
                    <button class="btn" onclick="connectDevice()">üîå Connect Device</button>
                </div>
            </div>
        </div>

        <div style="padding: 0 30px 30px;">
            <div class="panel">
                <h2>üìä Device Monitor</h2>
                <div id="deviceLog" class="log"></div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="clearLog()">üßπ Clear Log</button>
                    <button class="btn" onclick="sendHeartbeat()">üíì Send Heartbeat</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let device = null;
        let isConnected = false;
        let pins = [];

        // Key code mappings for easy selection
        const keyCodes = {
            // Letters
            'A': 65, 'B': 66, 'C': 67, 'D': 68, 'E': 69, 'F': 70, 'G': 71, 'H': 72,
            'I': 73, 'J': 74, 'K': 75, 'L': 76, 'M': 77, 'N': 78, 'O': 79, 'P': 80,
            'Q': 81, 'R': 82, 'S': 83, 'T': 84, 'U': 85, 'V': 86, 'W': 87, 'X': 88,
            'Y': 89, 'Z': 90,
            // Numbers
            '0': 48, '1': 49, '2': 50, '3': 51, '4': 52, '5': 53, '6': 54, '7': 55, '8': 56, '9': 57,
            // Special keys
            'Space': 32, 'Enter': 13, 'Tab': 9, 'Escape': 27, 'Backspace': 8,
            'Shift': 16, 'Ctrl': 17, 'Alt': 18,
            // Function keys
            'F1': 112, 'F2': 113, 'F3': 114, 'F4': 115, 'F5': 116, 'F6': 117,
            'F7': 118, 'F8': 119, 'F9': 120, 'F10': 121, 'F11': 122, 'F12': 123,
            // Mouse buttons
            'Mouse Left': 1, 'Mouse Right': 2, 'Mouse Middle': 4,
            // Media keys
            'Play/Pause': 0xCD, 'Volume Up': 0x30, 'Volume Down': 0x2E,
            'Next Track': 0x19, 'Previous Track': 0x10
        };

        // Initialize the interface
        window.addEventListener('load', function() {
            populateKeyCodeSelect();
            updateActionValueOptions();
            
            // Set up event listeners
            document.getElementById('hidAction').addEventListener('change', updateActionValueOptions);
            
            // Check for WebUSB support
            if (!navigator.usb) {
                logMessage('‚ùå WebUSB not supported in this browser');
                document.getElementById('statusText').textContent = 'WebUSB Not Supported';
                return;
            }
            
            logMessage('‚úÖ WebUSB supported - Ready to connect');
        });

        function populateKeyCodeSelect() {
            const select = document.getElementById('actionValue');
            select.innerHTML = '';
            
            // Add key codes organized by category
            const categories = {
                'Letters': Object.keys(keyCodes).filter(k => k.length === 1 && k >= 'A' && k <= 'Z'),
                'Numbers': Object.keys(keyCodes).filter(k => k.length === 1 && k >= '0' && k <= '9'),
                'Special Keys': ['Space', 'Enter', 'Tab', 'Escape', 'Backspace', 'Shift', 'Ctrl', 'Alt'],
                'Function Keys': Object.keys(keyCodes).filter(k => k.startsWith('F')),
                'Mouse': Object.keys(keyCodes).filter(k => k.startsWith('Mouse')),
                'Media': ['Play/Pause', 'Volume Up', 'Volume Down', 'Next Track', 'Previous Track']
            };
            
            for (const [category, keys] of Object.entries(categories)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                
                keys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = keyCodes[key];
                    option.textContent = `${key} (${keyCodes[key]})`;
                    optgroup.appendChild(option);
                });
                
                select.appendChild(optgroup);
            }
        }

        function updateActionValueOptions() {
            const actionType = parseInt(document.getElementById('hidAction').value);
            const select = document.getElementById('actionValue');
            
            // Filter options based on action type
            const options = select.querySelectorAll('option');
            const optgroups = select.querySelectorAll('optgroup');
            
            optgroups.forEach(group => {
                const label = group.label;
                let shouldShow = false;
                
                switch (actionType) {
                    case 1: // Keyboard Key
                    case 2: // Keyboard Modifier
                        shouldShow = ['Letters', 'Numbers', 'Special Keys', 'Function Keys'].includes(label);
                        break;
                    case 3: // Mouse Button
                        shouldShow = label === 'Mouse';
                        break;
                    case 4: // Mouse Movement
                        // For mouse movement, we'll use simple numeric values
                        shouldShow = false;
                        break;
                    case 5: // Media Key
                    case 6: // Consumer Key
                        shouldShow = label === 'Media';
                        break;
                    default:
                        shouldShow = true;
                }
                
                group.style.display = shouldShow ? '' : 'none';
            });
            
            // For mouse movement, add special options
            if (actionType === 4) {
                select.innerHTML = `
                    <option value="1">X Movement</option>
                    <option value="2">Y Movement</option>
                `;
            }
        }

        async function connectDevice() {
            try {
                logMessage('üîç Requesting WebUSB device...');
                
                device = await navigator.usb.requestDevice({
                    filters: [{ vendorId: 0x2341 }] // Arduino vendor ID
                });
                
                await device.open();
                await device.selectConfiguration(1);
                await device.claimInterface(2); // WebUSB interface
                
                isConnected = true;
                updateConnectionStatus(true);
                logMessage('‚úÖ Connected to device: ' + device.productName);
                
                // Start listening for data
                startDataReceiver();
                
                // Request initial pin status
                await sendCommand({ command: 'getPinStatus' });
                
            } catch (error) {
                logMessage('‚ùå Connection failed: ' + error.message);
                updateConnectionStatus(false);
            }
        }

        async function startDataReceiver() {
            try {
                while (isConnected && device) {
                    const result = await device.transferIn(2, 64);
                    if (result.data) {
                        const decoder = new TextDecoder();
                        const message = decoder.decode(result.data);
                        handleDeviceMessage(message.trim());
                    }
                }
            } catch (error) {
                if (isConnected) {
                    logMessage('üì° Data receiver error: ' + error.message);
                }
            }
        }

        function handleDeviceMessage(message) {
            if (!message) return;
            
            logMessage('üì® Received: ' + message);
            
            try {
                const data = JSON.parse(message);
                if (data.pins) {
                    pins = data.pins;
                    updatePinsList();
                }
            } catch (e) {
                // Not JSON, just log as text
            }
        }

        async function sendCommand(command) {
            if (!device || !isConnected) {
                logMessage('‚ùå Device not connected');
                return;
            }
            
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(JSON.stringify(command));
                await device.transferOut(2, data);
                logMessage('üì§ Sent: ' + JSON.stringify(command));
            } catch (error) {
                logMessage('‚ùå Send error: ' + error.message);
            }
        }

        async function addPin() {
            const pin = parseInt(document.getElementById('pinNumber').value);
            const mode = parseInt(document.getElementById('pinMode').value);
            const action = parseInt(document.getElementById('hidAction').value);
            const value = parseInt(document.getElementById('actionValue').value);
            const pullup = document.getElementById('pullupEnabled').checked;
            const inverted = document.getElementById('invertLogic').checked;
            
            const command = {
                command: 'addPin',
                pin: pin,
                mode: mode,
                action: action,
                value: value,
                pullup: pullup,
                inverted: inverted
            };
            
            await sendCommand(command);
        }

        async function removePin(pinNumber) {
            const command = {
                command: 'removePin',
                pin: pinNumber
            };
            
            await sendCommand(command);
        }

        async function clearAllPins() {
            if (confirm('Are you sure you want to clear all pins?')) {
                const command = { command: 'clearPins' };
                await sendCommand(command);
            }
        }

        async function refreshPins() {
            const command = { command: 'getPinStatus' };
            await sendCommand(command);
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'Connected';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'Disconnected';
            }
        }

        function updatePinsList() {
            const container = document.getElementById('pinsList');
            
            if (pins.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No pins configured</div>';
                return;
            }
            
            const actionNames = ['None', 'Keyboard Key', 'Keyboard Modifier', 'Mouse Button', 'Mouse Movement', 'Media Key', 'Consumer Key'];
            const modeNames = ['Digital Input', 'Digital Output', 'Analog Input'];
            
            let html = '';
            pins.forEach(pin => {
                html += `
                    <div class="pin-item">
                        <div class="pin-header">
                            <div class="pin-title">Pin ${pin.pin}</div>
                            <button class="btn btn-danger" onclick="removePin(${pin.pin})" style="padding: 5px 10px; font-size: 12px;">Remove</button>
                        </div>
                        <div class="pin-details">
                            <strong>Mode:</strong> ${modeNames[pin.mode]}<br>
                            <strong>Action:</strong> ${actionNames[pin.action]}<br>
                            <strong>Value:</strong> ${pin.value}<br>
                            <strong>Options:</strong> ${pin.pullup ? 'Pullup ' : ''}${pin.inverted ? 'Inverted' : ''}<br>
                            ${pin.currentState !== undefined ? `<strong>Current State:</strong> ${pin.currentState}` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function logMessage(message) {
            const log = document.getElementById('deviceLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('deviceLog').innerHTML = '';
        }

        async function sendHeartbeat() {
            await sendCommand({ command: 'heartbeat' });
        }

        // Quick setup functions
        async function setupKeyboard() {
            if (!confirm('This will clear existing pins and set up a basic keyboard layout. Continue?')) return;
            
            await sendCommand({ command: 'clearPins' });
            
            // Common keyboard keys
            const keyboardPins = [
                { pin: 0, key: 'Space', value: 32 },
                { pin: 1, key: 'Enter', value: 13 },
                { pin: 2, key: 'A', value: 65 },
                { pin: 3, key: 'S', value: 83 },
                { pin: 4, key: 'D', value: 68 },
                { pin: 5, key: 'W', value: 87 }
            ];
            
            for (const setup of keyboardPins) {
                await sendCommand({
                    command: 'addPin',
                    pin: setup.pin,
                    mode: 0, // Digital input
                    action: 1, // Keyboard key
                    value: setup.value,
                    pullup: true,
                    inverted: false
                });
            }
            
            logMessage('‚å®Ô∏è Keyboard setup complete');
        }

        async function setupMouse() {
            if (!confirm('This will clear existing pins and set up mouse controls. Continue?')) return;
            
            await sendCommand({ command: 'clearPins' });
            
            const mousePins = [
                { pin: 0, action: 3, value: 1 }, // Left click
                { pin: 1, action: 3, value: 2 }, // Right click
                { pin: 2, action: 3, value: 4 }, // Middle click
                { pin: 3, action: 4, value: 1 }, // X movement (analog)
                { pin: 4, action: 4, value: 2 }  // Y movement (analog)
            ];
            
            for (const setup of mousePins) {
                await sendCommand({
                    command: 'addPin',
                    pin: setup.pin,
                    mode: setup.action === 4 ? 2 : 0, // Analog for movement, digital for clicks
                    action: setup.action,
                    value: setup.value,
                    pullup: setup.action !== 4,
                    inverted: false
                });
            }
            
            logMessage('üñ±Ô∏è Mouse setup complete');
        }

        async function setupMedia() {
            if (!confirm('This will clear existing pins and set up media controls. Continue?')) return;
            
            await sendCommand({ command: 'clearPins' });
            
            const mediaPins = [
                { pin: 0, value: 0xCD }, // Play/Pause
                { pin: 1, value: 0x30 }, // Volume Up
                { pin: 2, value: 0x2E }, // Volume Down
                { pin: 3, value: 0x19 }, // Next Track
                { pin: 4, value: 0x10 }  // Previous Track
            ];
            
            for (const setup of mediaPins) {
                await sendCommand({
                    command: 'addPin',
                    pin: setup.pin,
                    mode: 0, // Digital input
                    action: 5, // Media key
                    value: setup.value,
                    pullup: true,
                    inverted: false
                });
            }
            
            logMessage('üéµ Media controls setup complete');
        }

        async function setupGaming() {
            if (!confirm('This will clear existing pins and set up gaming controls (WASD + Space). Continue?')) return;
            
            await sendCommand({ command: 'clearPins' });
            
            const gamingPins = [
                { pin: 0, key: 'W', value: 87 },   // Forward
                { pin: 1, key: 'A', value: 65 },   // Left
                { pin: 2, key: 'S', value: 83 },   // Backward
                { pin: 3, key: 'D', value: 68 },   // Right
                { pin: 4, key: 'Space', value: 32 }, // Jump
                { pin: 5, action: 3, value: 1 }    // Shoot (left click)
            ];
            
            for (const setup of gamingPins) {
                await sendCommand({
                    command: 'addPin',
                    pin: setup.pin,
                    mode: 0, // Digital input
                    action: setup.action || 1, // Keyboard key or specified action
                    value: setup.value,
                    pullup: true,
                    inverted: false
                });
            }
            
            logMessage('üéÆ Gaming controls setup complete');
        }

        // Handle disconnection
        window.addEventListener('beforeunload', async function() {
            if (device && isConnected) {
                isConnected = false;
                try {
                    await device.close();
                } catch (e) {
                    // Ignore errors during cleanup
                }
            }
        });
    </script>
</body>
</html>
